"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),ScrollLoad=function(){function t(e){var n=this;_classCallCheck(this,t),e.scrollContanier=$(e.scrollContanier),void 0!=e.listContanier&&(e.listContanier=$(e.listContanier));var i={maxload:1e3,perload:27,loading:!1,currentPage:1,listContanier:e.scrollContanier,scrollContanier:e.scrollContanier};e=$.extend({},i,e);for(var o in e)e.hasOwnProperty(o)&&(this[o]=e[o]);this.preloader=$('\n            <div class="infinite-scroll-preloader">\n                <div class="preloader"></div>\n            </div>\n        ').appendTo(this.listContanier),this.perload>this.maxload&&(this.perload=this.maxload),this.scrollContanier.on("scroll",function(){n.scroll()}),this.ajax({openId:$.openId,skip:1,limit:this.perload},function(t){t.length&&(n.currentPage++,n.render(t)),t.length<=n.perload&&n.finish()})}return _createClass(t,[{key:"scroll",value:function(){var t=this;if(!(this.scrollContanier.scrollTop()+this.scrollContanier.height()+100<this.scrollContanier[0].scrollHeight||this.loading)){if(this.listContanier.children().length>=this.maxload)return void this.finish();this.loading=!0,this.ajax({openId:$.openId,skip:this.currentPage,limit:this.perload},function(e){return t.loading=!1,e.length<=0?void t.finish():(t.currentPage++,void t.render(e))})}}},{key:"reload",value:function(){var t=this;this.scrollContanier[0].scrollTop=0,this.preloader.html('<div class="preloader"></div>'),this.currentPage=1,this.loading=!1,this.scrollContanier.on("scroll",function(){t.scroll()}),$.showIndicator(),this.ajax({openId:$.openId,skip:1,limit:this.perload},function(e){t.listContanier.empty(),e.length?(t.currentPage++,t.render(e)):t.finish(),$.hideIndicator()})}},{key:"finish",value:function(){this.scrollContanier.off("scroll");var t=this.preloader[0].offsetTop,e=this.listContanier.height()-parseInt(this.listContanier.css("padding-top"));t>e-10?this.preloader.text("已经到底了！"):this.preloader.text("")}},{key:"render",value:function(t){this.perload<t.length&&(t.length=this.perload);var e=this.template(t);this.listContanier.append(e),this.preloader.appendTo(this.listContanier)}}]),t}();$(document).on("click",".getMovie",function(){function t(t){var e=$(".movieDetails");e.find(".pic").attr("src",t.MOVIE.poster)}var e=$(this),n=e.attr("movieId");$.ajax({type:"get",url:"http://wechat.94joy.com/wx/rest/index/getMovie",data:{movieId:n},success:function(e){console.log(e),t(e)},error:function(t){console.log("影视详情页获取失败。",t)}})}),$.fn.init=function(t){for(var e=0;e<this.length;e++){var n=$(this[e]);"img"===this[e].localName?n.attr("src",t):void 0==n.val()?n.text(t):n.val(t),n.removeClass("hide").show()}},$.GetQueryString=function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(e);return null!=n?unescape(n[2]):null},$.openId=$.GetQueryString("openid"),null===$.openId?$.openId=sessionStorage.openId:sessionStorage.openId=$.openId,$.getMovDetails=function(t){return"./movieDetails.html?movieId="+t+"&oldOpenId="+$.openId},$.getArtDetails=function(t){return"./articleDetails.html?articleId="+t+"&oldOpenId="+$.openId},$.msg=function(t,e){var n=t.text||t,i=t.title||"温馨提示",o=t.callback;void 0===e&&(e=t.timeout||2e3);var r=$('\n        <div class="mask">\n            <div class="msg">\n                <p class="msg-title">'+i+'</p>\n                <p class="msg-text">'+n+"</p>\n            </div>\n        </div>\n    ");$("body").append(r),e&&setTimeout(function(){r.remove(),o&&o()},e)},$.payment=function(t){function e(){$.showPreloader("购买中，稍等..."),$.ajax({url:"http://wechat.94joy.com/wx/rest/pay/payByRecharge",data:{openId:$.openId,movieId:t.movieId},success:function(e){console.log("余额支付接口",e),1==e.STATUS?t.success():$.msg("账户余额不足，请充值或使用微信支付！",5e3)},error:function(){$.msg("系统繁忙，请稍后再尝试支付操作！")},complete:function(){$.hidePreloader()}})}var n=[{text:"账户余额支付",onClick:function(){e()}},{text:"微信支付",onClick:function(){t.wxPay.productId=t.productId,$.wxPay(t.wxPay,function(){t.success()})}},{text:"取消"}];$.actions(n)},$.wxPay=function(t,e){console.log(t),$.showIndicator(),$.ajax({url:"http://118.178.136.60:8001/rest/pay/toPay",data:{type:t.type,title:t.title,openId:$.openId,productId:t.productId,url:location.href.split("#")[0]},success:function(t){console.log("统一下单接口：",t),wx.config({appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["chooseWXPay"]}),wx.ready(function(){wx.chooseWXPay({appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,package:"prepay_id="+t.prepay_id,signType:t.signType,paySign:t.paySign,success:function(t){"chooseWXPay:ok"==t.errMsg?e():alert(t.errMsg)},cancel:function(t){$.msg("支付取消")},fail:function(){$.msg("充值失败，请小主稍后再试！",5e3)}})})},error:function(t){$.alert("充值服务初始化失败，请稍后再试！"),console.log("充值失败",t)},complete:function(){$.hideIndicator()}})},$.pageInit=function(t){$(t.entry).one("click",function(){t.init()}),location.hash.indexOf(t.hash)>0&&(t.init(),$(t.entry).off("click"))};