"use strict";function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}}(),ScrollLoad=function(){function t(n){var e=this;_classCallCheck(this,t),n.scrollContanier=$(n.scrollContanier),void 0!=n.listContanier&&(n.listContanier=$(n.listContanier));var i={maxload:1e3,perload:27,loading:!1,currentPage:1,listContanier:n.scrollContanier,scrollContanier:n.scrollContanier};n=$.extend({},i,n);for(var o in n)n.hasOwnProperty(o)&&(this[o]=n[o]);this.preloader=$('\n            <div class="infinite-scroll-preloader">\n                <div class="preloader"></div>\n            </div>\n        ').appendTo(this.listContanier),this.perload>this.maxload&&(this.perload=this.maxload),this.scrollContanier.on("scroll",function(){e.scroll()}),this.ajax({openId:$.openId,skip:1,limit:this.perload},function(t){e._ajax(t)})}return _createClass(t,[{key:"_ajax",value:function(t){t.length?(this.currentPage++,this.render(t),t.length<this.perload&&this.finish()):this.finish()}},{key:"scroll",value:function(){var t=this;if(!(this.scrollContanier.scrollTop()+this.scrollContanier.height()+100<this.scrollContanier[0].scrollHeight||this.loading)){if(this.listContanier.children().length>=this.maxload)return void this.finish();this.loading=!0,this.ajax({openId:$.openId,skip:this.currentPage,limit:this.perload},function(n){t.loading=!1,t._ajax(n)})}}},{key:"reload",value:function(){var t=this;this.scrollContanier[0].scrollTop=0,this.preloader.html('<div class="preloader"></div>'),this.currentPage=1,this.loading=!1,this.scrollContanier.on("scroll",function(){t.scroll()}),$.showIndicator(),this.ajax({openId:$.openId,skip:1,limit:this.perload},function(n){t.listContanier.empty(),t._ajax(n),$.hideIndicator()})}},{key:"finish",value:function(){this.scrollContanier.off("scroll");var t=this.preloader[0].offsetTop,n=this.listContanier.height()-parseInt(this.listContanier.css("padding-top"));t>n-10?this.preloader.text("已经到底了！"):this.preloader.text("")}},{key:"render",value:function(t){this.perload<t.length&&(t.length=this.perload);var n=this.template(t);this.listContanier.append(n),this.preloader.appendTo(this.listContanier)}}]),t}();setTimeout(function(){var t=$(".scroll");if(0!=t.length){t.on("touchstart",function(t){var n=$(this)[0],e=n.scrollTop,i=n.scrollHeight,o=e+n.offsetHeight;0===e?n.scrollTop=1:o===i&&(n.scrollTop=e-1)}),t.on("touchmove",function(t){var n=$(this)[0];n.offsetHeight<n.scrollHeight&&(t._isScroller=!0)});var n=$("body").off("touchmove");n.on("touchmove",function(t){t._isScroller||t.preventDefault()})}},100),$(document).on("click",".getMovie",function(){function t(t){var n=$(".movieDetails");n.find(".pic").attr("src",t.MOVIE.poster)}var n=$(this),e=n.attr("movieId");$.ajax({type:"get",url:"http://www.funying.cn/wx/rest/index/getMovie",data:{movieId:e},success:function(n){console.log(n),t(n)},error:function(t){console.log("影视详情页获取失败。",t)}})}),$.fn.init=function(t){if(null!=t)for(var n=0;n<this.length;n++){var e=$(this[n]);"img"===this[n].localName?e.attr("src",t):void 0==e.val()?e.text(t):e.val(t),e.removeClass("hide").css("visibility","visible").show()}else this.removeClass("hide").css("visibility","visible")},$.GetQueryString=function(t){var n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),e=window.location.search.substr(1).match(n);return null!=e?unescape(e[2]):null},$.openId=$.GetQueryString("openid"),null===$.openId?$.openId=sessionStorage.openId:sessionStorage.openId=$.openId,$.getMovDetails=function(t){return"./movieDetails.html?movieId="+t+"&oldOpenId="+$.openId},$.getArtDetails=function(t){return"./articleDetails.html?articleId="+t+"&oldOpenId="+$.openId},$.msg=function(t,n){var e=t.text||t,i=t.title||"温馨提示",o=t.callback;void 0===n&&(n=t.timeout||2e3);var s=$('\n        <div class="mask">\n            <div class="msg">\n                <p class="msg-title">'+i+'</p>\n                <p class="msg-text">'+e+"</p>\n            </div>\n        </div>\n    ");$("body").append(s),n&&setTimeout(function(){s.remove(),o&&o()},n)},$.payment=function(t){function n(){$.showPreloader("购买中，稍等..."),$.ajax({url:"http://www.funying.cn/wx/rest/pay/payByRecharge",data:{openId:$.openId,movieId:t.productId},success:function(n){console.log("余额支付接口",n),1==n.STATUS?t.success():$.msg("账户余额不足，请充值或使用微信支付！",5e3)},error:function(){$.msg("系统繁忙，请稍后再尝试支付操作！")},complete:function(){$.hidePreloader()}})}var e=[{text:"账户余额支付",onClick:function(){n()}},{text:"取消"}];$.actions(e)},$.wxPay=function(t,n){var e={type:t.type,title:t.title,openId:$.openId,productId:t.productId,url:location.href.split("#")[0]};console.log("统一下单接口参数",e),$.showIndicator(),$.ajax({url:"http://www.funying.cn/movie/rest/pay/toPay",data:e,success:function(t){console.log("统一下单接口：",t),wx.config({appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["chooseWXPay"]}),wx.ready(function(){wx.chooseWXPay({appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,package:"prepay_id="+t.prepay_id,signType:t.signType,paySign:t.paySign,success:function(t){"chooseWXPay:ok"==t.errMsg?n():alert(t.errMsg)},cancel:function(t){$.msg("支付取消")},fail:function(){$.msg("充值失败，请小主稍后再试！",5e3)}})})},error:function(t){$.alert("充值服务初始化失败，请稍后再试！"),console.log("充值失败",t)},complete:function(){$.hideIndicator()}})},$.pageInit=function(t){$(t.entry).one("click",function(){t.init()}),location.hash.indexOf(t.hash)>0&&(t.init(),$(t.entry).off("click"))},$.formatAmount=function(t){return t=Number(t),t?t.toFixed(2):0},$.getUpdateStatus=function(t,n){return 0==t?n?"第"+n+"集":"更新中":"已完结"},$.shareConfig=function(t){$.ajax({url:"http://www.funying.cn/wx/rest/pay/getSignConf",data:{url:location.href.split("#")[0]},success:function(n){t(n)}})};